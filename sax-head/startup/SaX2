#!/bin/sh
# Copyright (c) 2000 SuSE GmbH Nuernberg, Germany.  All rights reserved.
#
# Author: Marcus Schaefer <sax@suse.de>, 2000
#
# SaX (sax) configuration level 3
#
# CVS ID:
# --------
# Status: Up-to-date
#
trap "signal" EXIT HUP INT TERM PIPE QUIT ABRT SEGV

#========================================
# Functions
#----------------------------------------
function signal {
	killall dots.pl 2>/dev/null >/dev/null
	test -n "$TMPFILE" && rm -f $TMPFILE
}

function validRunlevel {
	TTY=`tty`
	REAL_TTY=0
	case "$TTY" in
		/dev/t*) REAL_TTY=1 ;;
	esac
	RUN=`/sbin/runlevel | cut -f2 -d" "`
	if [ "$REAL_TTY" -eq 1 ];then
	if [ "$RUN" -gt "3" ] || [ "$RUN" -lt "2" ];then
		echo "SaX2: Invalid runlevel for console mode"
		echo "SaX2: Please switch to runlevel 3 first"
		echo 
		echo "      init 3"
		echo
		echo "SaX2: abort..."
		exit 0
	fi
	fi
}

#========================================
# Init
#----------------------------------------
ERR="/var/log/SaX.log"
SHC="/bin/sh"
SUX="/usr/X11R6/bin/sux"

if [ -z "$DISPLAY" ];then
	export DISPLAY=:0
fi

#========================================
# Main
#----------------------------------------
for param;do
	if [ $param = "-v" ] || [ $param = "--version" ];then
		/usr/sbin/sax.sh -v
		exit 0
	fi
	if [ $param = "-h" ] || [ $param = "--help" ];then
		/usr/sbin/sax.sh -h
		exit 0
	fi
done
validRunlevel

# lookup temp file for language information...
# ----------------------------------------------
if [ ! "$UID" = 0 ];then
	TMPFILE=`mktemp -q /tmp/sax_lenv.XXXXXX`
	if [ $? -ne 0 ]; then
	echo "SaX: Can't create tmp file, exiting..."
	exit 1
	fi 
fi

# test for root privileges...
# ---------------------------
if [ ! "$UID" = 0 ];then
	# export LANG user environment...
	# ---------------------------------
	echo $LANG >> $TMPFILE

	echo -n "SaX: root "
	if [ -f "$SUX" ];then
		sux -c "/usr/sbin/SaX2 $*"
	else
		xhost + localhost > /dev/null 2>/dev/null
		su - -c "/usr/sbin/SaX2 $*"
	fi

	if [ ! "$?" = 0 ];then
	echo
	if [ ! -f "$SUX" ];then
		xhost - localhost 2>/dev/null >/dev/null
	fi
	exit 1
	fi

	if [ ! -f "$SUX" ];then
		xhost - localhost 2>/dev/null >/dev/null
	fi
	exit 0
fi

# run the main sax start script...
# ---------------------------------
/usr/sbin/sax.sh $*
